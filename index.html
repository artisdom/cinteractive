<!DOCTYPE html>
<html lang="en">
   <head>
      <meta http-equiv="content-type" content="text/html; charset=utf-8">
      <title>C Interactive Interpreter</title>
      <link href="static/css/smoothness/jquery-ui-1.10.2.custom.css" rel="stylesheet">
      <script type="text/javascript" src="static/js/jquery-1.9.1.js"></script>
      <script src="static/js/jquery-ui-1.10.2.custom.js"></script>
      <script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/lodash.js/1.2.0/lodash.js"></script>
      <script type="text/javascript" src="static/js/interp/prettyprint.js"></script>
      <script type="text/javascript" src="static/js/interp/interpreter.js"></script>
      <script type="text/javascript" src="static/js/interp/stepper.js"></script>
      <!-- TODO: really should learn a module system or something for the javascript -->
      <script>
         // THIS IS THE STATE OF THE INTERPRETER
         var glState;

         function fun_args(fun) {
            var ret = '<div id="args">';
               ret += '<ul class="args">';
                  _(fun["attrs"][0]["params"]).map(function(p) {
                     ret += '<li class="arg">';
                     ret += print_type(p["specifiers"][0]["spec"]["node"]);
                     ret += "&nbsp;&nbsp;&nbsp;";
                     ret += "<input type='text' class='param' value='";
                     ret += unquotify(p["declarations"][0]['declarator']["name"]);
                     ret += "'>";
                     ret += '</li>';
                  });
                  ret += '</ul>';
               ret += '</div>';
            return ret;
         }

         function updateMemory(st) {
            var mem = $('#memory');
            mem.empty();

            var stack = $('#stack');
            $('#stack .var_row').remove();

            _(st.heap).forIn(function(value, loc) {
               var li = $('<li></li>');
               li.addClass('mem');
               li.html('<span class="loc">' + loc + '</span>' + '<span class="value">' + ppMemValue(value) + '</span>');
               mem.append(li);
            });

            var num_frames = st.stack.length;
            _(st.stack).map(function(frame, frameIdx){
               _(frame).forIn(function(addr, name) {
                  var var_row = $('<tr></tr>');
                  var_row.addClass('var_row');
                  if (frameIdx === num_frames - 1)
                     var_row.addClass('global');

                  var varbl = $('<td></td>');
                  varbl.addClass('var_name');
                  varbl.html(name);
                  var adcl = $('<td></td>');
                  adcl.addClass('var_addr');
                  adcl.html(addr);

                  var_row.append(varbl);
                  var_row.append(adcl);
                  stack.append(var_row);
               });
            });
         }

         function receiveAST(data) {
            $('#source').html(ipprint(data));

            // TODO: error handling
            if (data["node"] !== "CTranslUnit") {
               $('#functions').html('error');
               return;
            }

            $('#functions').empty();

            // create an li for each decl
            _(data["decls"])
               .filter(function(node) {
                  if (node["node"] === "CFunDef") return true; else return false;})
               .map('fun_def')
               .map(function(fun) {
               $('#functions').append('<h3>' + unquotify(fun["name"]) + fun_args(fun) + '</h3><div class="context"><a href="#" data-function="' + unquotify(fun["name"]) + '">Run</a></div>');
            });


            glState = compile(data);
            glState.kont($('#whatsgoingon'));
            updateMemory(glState);
            var newstack = [{}];
            glState.stack = newstack.concat(glState.stack);
            $('#functions').accordion();
         }

         function enlarge() { $('#source').addClass('enlarge'); }

         var cidx = -1,
             controlsLen = 0;
         $(document).ready(function() {
            $('#step').click(function() {
               if (_(glState.control).isArray()) {
                  var controls = glState.control;
                  if (cidx < 0) {
                     cidx = 0;
                     controlsLen = controls.length;
                  }
                  glState.control = controls[cidx];
                  glState = step[glState.control["node"]](glState);
                  glState.kont($('#whatsgoingon'));
                  glState.control = controls;
                  cidx++;
               } else if (_(glState.control).isObject()) {
                  glState = step[glState.control["node"]](glState);
                  glState.kont($('#whatsgoingon'));
               }
               updateMemory(glState);
            });
            $('#code').focus();
            $("#compile").click(function() {
               $('#functions').empty();
               $('#source').empty();
               $.post('http://localhost:3000/parse', $('#code').val())
               .success(receiveAST)
               .error(function(err) { $('#functions').html(err)});
               return false;
            });
         });
      </script>
      <!--<link href="static/css/bootstrap.css" rel="stylesheet">-->
      <link rel="stylesheet" href="static/css/style.css">
   </head>
   <body>
      <div class="container">
         <button id="compile">Compile</button>
         <div id="topbar">
            <ul id="toplinks">
               <li><a href="#" id="compile">Compile</a></li>
            </ul>
         </div>
         <div class="codecontainer">
            <div class="line-nums">

            </div>
<textarea id="code">
unsigned int global_var, global_twar = 3;

int dup(int num) {
   int i;
   int a;
   for (i = 0; i &lt; num; i++)
      a = num + 1;

   return a;
}

int main() {
   int num = 5;
   num = dup(num);
   printf("%d\n", num);

   return 0;
}</textarea>
         </div>
         <div id="controls">
            <div id="steps">
               <a href="#" id="step">Step</a>
               <div id="whatsgoingon"></div>
               <br>
               <input type="range" name="step" id="step" min="1" max="10" value="0">
            </div>
            <ul id="functions">
            </ul>
         </div>

         <br style="clear: both;">
      </div>
      <table id="stack">
         <tr>
            <th>Variable Name</th>
            <th>Memory Location</th>
         </tr>
      </table>
      <div id="memory-container">
         <h2>Memory</h2>
         <ul id="memory">
         </ul>
      </div>
      <br>
      <div id="source">
      </div>
      <script type="text/javascript" src="static/js/behave.js"></script>
      <script type="text/javascript">
         var lineNumberFunc = function(data) {
            var numLines = data.lines.total,
               house = $('.line-nums'),
               html = '',
               i;

            for (i = 0; i < numLines; i++) {
               html += '<div>' + (i + 1) + '</div>';
            }

            house.html(html);
         };
         BehaveHooks.add(['init-after', 'keydown'], lineNumberFunc);

         var editor = new Behave({
            textarea: document.getElementById('code'),
            replaceTab: true,
            softTabs: true,
            tabSize: 3,
            autoStrip: true,
            overwrite: true,
            autoOpen: true,
            autoIndent: true
         });
         </script>
   </body>
</html>
